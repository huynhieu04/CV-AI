<div class="page">
    <!-- HEADER -->
    <header class="page__header">
        <div>
            <h1 class="page__title">Ph√¢n Lo·∫°i CV</h1>
            <p class="page__subtitle">
                Upload CV c·ªßa ·ª©ng vi√™n, backend s·∫Ω tr√≠ch xu·∫•t n·ªôi dung, chu·∫©n h√≥a d·ªØ li·ªáu v√† d√πng AI (Gemini)
                ƒë·ªÉ so kh·ªõp v·ªõi c√°c Job Description trong h·ªá th·ªëng.
            </p>
            <p class="page__subtitle page__subtitle--meta">
                AI + Gemini ‚Ä¢ Graduation Project ‚Ä¢ Flow: Upload CV ‚Üí AI ph√¢n t√≠ch ‚Üí G·ª£i √Ω & x·∫øp h·∫°ng c√°c job ph√π h·ª£p.
            </p>
        </div>
    </header>

    <!-- GRID 2 C·ªòT -->
    <div class="page__grid">
        <!-- LEFT: Upload -->
        <section class="card card--upload">
            <h2 class="card__title">1. Upload CV ƒë·ªÉ AI ƒë·ªçc & ph√¢n lo·∫°i</h2>
            <p class="card__sub card__sub--upload">
                H·ªó tr·ª£ <span class="fmt">PDF</span>, <span class="fmt">DOC/DOCX</span>, <span
                    class="fmt">JPG/PNG</span>.
                Sau khi upload, backend s·∫Ω tr√≠ch xu·∫•t text, chu·∫©n h√≥a d·ªØ li·ªáu v√† ch·∫°y AI ƒë·ªÉ so kh·ªõp v·ªõi
                t·∫•t c·∫£ v·ªã tr√≠ tuy·ªÉn d·ª•ng trong h·ªá th·ªëng.
            </p>

            <!-- Upload area -->
            <label class="upload-box__area">
                <input #fileInput type="file" multiple class="upload-box__input"
                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" (change)="onFilesChange($event, fileInput)" />

                <div class="upload-box__content">
                    <div class="tag-pill">
                        {{ selectedFileName || 'Ch·ªçn ho·∫∑c k√©o CV v√†o ƒë√¢y' }}
                    </div>

                    <div class="upload-box__text">
                        {{
                        selectedFileName
                        ? 'ƒê√£ ch·ªçn: ' + selectedFileName
                        : 'H·ªó tr·ª£ PDF, DOC/DOCX, JPG/PNG. Dung l∆∞·ª£ng < 10MB/file.' }} </div>
                    </div>
            </label>

            <!-- Actions -->
            <div class="run-row">
                <div class="run-actions">
                    <button class="btn btn--primary btn--sm" type="button" (click)="onRunMatching()"
                        [disabled]="!selectedFiles.length || isMatching">
                        <span class="btn__icon">üöÄ</span>
                        <span *ngIf="!isMatching">X·ª≠ l√≠ CV</span>
                        <span *ngIf="isMatching">ƒêang x·ª≠ l√Ω...</span>
                    </button>

                    <button class="btn btn--ghost btn--sm" type="button" (click)="clearSelectedFiles()"
                        [disabled]="isMatching">
                        <span class="btn__icon">üßπ</span>
                        X√≥a
                    </button>
                </div>

                <span class="run-row__hint">
                    Flow: Upload CV ‚Üí Backend parse PDF/Word ‚Üí Chu·∫©n h√≥a d·ªØ li·ªáu ‚Üí G·ªçi Gemini ph√¢n t√≠ch ‚Üí X·∫øp h·∫°ng job.
                </span>
            </div>

            <!-- Error -->
            <p *ngIf="errorMessage" class="error-text">
                {{ errorMessage }}
            </p>
        </section>

        <!-- RIGHT: Results -->
        <section class="card card--result">
            <ng-container *ngIf="batchItems.length; else emptyResult">
                <!-- ‚úÖ CV selector list (filter theo CV) -->
                <div class="cv-switcher">
                    <div class="cv-switcher__title">Danh s√°ch CV ƒë√£ upload</div>

                    <div class="cv-list">
                        <button class="cv-item" *ngFor="let it of batchItems" type="button"
                            (click)="setActiveCv(it.key)" [class.cv-item--active]="isActiveCv(it.key)">
                            <div class="cv-item__name">{{ it.label }}</div>
                            <div class="cv-item__meta">
                                <span class="cv-item__pill">{{ it.rows.length }} job</span>
                                <span class="cv-item__pill" *ngIf="it.firstRow as fr">{{ fr.matchScore }}%</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- ‚úÖ Detail panel (gi·ªëng UI c≈©, nh∆∞ng theo CV ƒëang ch·ªçn) -->
                <div class="detail-panel" *ngIf="selectedCandidate; else noDetail">
                    <div class="match-card__header">
                        <div>
                            <h2 class="card__title">
                                {{ selectedCandidate.name }}
                            </h2>
                            <p class="card__sub">
                                ƒê·ªÅ xu·∫•t: {{ selectedCandidate.recommendedJob }}
                            </p>

                            <div class="match-card__tags">
                                <span class="tag-pill" *ngFor="let t of matchTags">{{ t }}</span>
                            </div>
                        </div>

                        <div class="match-card__score-wrap">
                            <div class="match-card__score-label">M·ª©c ƒê·ªô Ph√π H·ª£p</div>
                            <div class="match-card__score-value">
                                {{ selectedCandidate.matchScore }}%
                            </div>
                            <div class="match-card__bar">
                                <div class="match-card__bar-fill" [style.width.%]="selectedCandidate.matchScore"></div>
                            </div>

                            <div class="match-card__status-row">
                                <span class="match-card__status-label">Tr·∫°ng th√°i</span>
                                <span class="badge" [ngClass]="{
                  'badge--success': selectedCandidate.status === 'Suitable',
                  'badge--warning': selectedCandidate.status === 'Potential',
                  'badge--danger': selectedCandidate.status === 'NotFit'
                }">
                                    {{ statusLabel(selectedCandidate.status) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Summary t·ª´ AI -->
                    <div *ngIf="matchSummary as summary" class="match-card__summary">
                        <p class="match-card__summary-title">T√≥m T·∫Øt T·ª´ AI</p>

                        <div *ngIf="summary.mainSkills.length" class="summary-row">
                            <div class="summary-label">K·ªπ nƒÉng:</div>
                            <div class="summary-value">{{ summary.mainSkills.join(', ') }}</div>
                        </div>

                        <div *ngIf="summary.mainDomains.length" class="summary-row">
                            <div class="summary-label">Lƒ©nh v·ª±c:</div>
                            <div class="summary-value">{{ summary.mainDomains.join(', ') }}</div>
                        </div>

                        <div *ngIf="summary.seniority" class="summary-row">
                            <div class="summary-label">C·∫•p ƒë·ªô:</div>
                            <div class="summary-value">{{ seniorityLabel(summary.seniority) }}</div>
                        </div>
                    </div>
                </div>

                <ng-template #noDetail>
                    <div class="empty-mini">
                        CV n√†y ch∆∞a c√≥ k·∫øt qu·∫£ ph√π h·ª£p (ho·∫∑c b·ªã l·ªçc d∆∞·ªõi 10%).
                    </div>
                </ng-template>
            </ng-container>

            <!-- Empty state -->
            <ng-template #emptyResult>
                <div class="empty-state">
                    <div class="robot" [class.robot--thinking]="isMatching || isLoadingFromDb">
                        <div class="robot__head">
                            <div class="robot__eye"></div>
                            <div class="robot__eye"></div>
                        </div>
                        <div class="robot__body"></div>
                    </div>

                    <h3 class="empty-state__title">
                        {{ (isMatching || isLoadingFromDb) ? 'AI ƒëang ph√¢n t√≠ch CV...' : 'Ch∆∞a c√≥ k·∫øt qu·∫£ AI' }}
                    </h3>

                    <p class="empty-state__text">
                        <ng-container *ngIf="!isMatching">
                            H√£y upload m·ªôt ho·∫∑c nhi·ªÅu CV, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch v√† g·ª£i √Ω c√¥ng vi·ªác ph√π h·ª£p nh·∫•t.
                        </ng-container>
                        <ng-container *ngIf="isMatching">
                            ƒêang tr√≠ch xu·∫•t n·ªôi dung CV, chu·∫©n h√≥a d·ªØ li·ªáu v√† so kh·ªõp v·ªõi Job Description...
                        </ng-container>
                    </p>

                    <div *ngIf="isMatching || isLoadingFromDb" class="loading-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </ng-template>
        </section>
    </div>

    <!-- TABLE: X·∫øp h·∫°ng c√°c job (‚úÖ ƒë√£ filter theo CV ƒëang ch·ªçn) -->
    <section class="card page__section--below" *ngIf="candidates.length">
        <div class="card__header">
            <div>
                <h2 class="card__title">K·∫øt Qu·∫£ AI So Kh·ªõp</h2>
                <p class="card__sub">
                    Danh s√°ch c√°c v·ªã tr√≠ ph√π h·ª£p ƒë∆∞·ª£c AI x·∫øp h·∫°ng t·ª´ cao ƒë·∫øn th·∫•p. Click m·ªôt d√≤ng ƒë·ªÉ xem chi ti·∫øt b√™n
                    ph·∫£i.
                </p>
            </div>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>·ª®ng Vi√™n</th>
                    <th>V·ªã Tr√≠ ƒê·ªÅ Xu·∫•t</th>
                    <th>M·ª©c ƒê·ªô Ph√π H·ª£p</th>
                    <th>Tr·∫°ng Th√°i</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let c of candidates" (click)="onSelectCandidate(c)"
                    [class.table__row--selected]="c === selectedCandidate">
                    <td>{{ c.name }}</td>
                    <td>{{ c.recommendedJob }}</td>
                    <td>{{ c.matchScore }}%</td>
                    <td>
                        <span class="badge" [ngClass]="{
              'badge--success': c.status === 'Suitable',
              'badge--warning': c.status === 'Potential',
              'badge--danger': c.status === 'NotFit'
            }">
                            {{ statusLabel(c.status) }}
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    </section>
</div>